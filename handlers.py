from telegram import (
    Update,
    ReplyKeyboardRemove,
    InlineKeyboardMarkup,
    InlineKeyboardButton,
)
from telegram.ext import (
    ContextTypes,
    ConversationHandler,
)
from datetime import datetime
import asyncio

from stripe_client import create_checkout_session
from pdf_generator import text_to_pdf, upload_pdf_to_storage
from prompts import build_destiny_prompt
from openai_client import ask_gpt
from supabase_client import get_user, create_user, update_user

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Conversation states
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
DATE, TIME, LOCATION = range(3)

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# /start â€“ Ğ¿Ñ€Ğ¸Ğ²ĞµÑ‚ÑÑ‚Ğ²Ğ¸Ğµ + inlineâ€‘ĞºĞ½Ğ¾Ğ¿ĞºĞ°, Ğ´Ğ¸Ğ°Ğ»Ğ¾Ğ³ Ğ¿Ğ¾ĞºĞ° ĞĞ• Ğ·Ğ°Ğ¿ÑƒÑ‰ĞµĞ½
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """ĞŸÑ€Ğ¸Ğ²ĞµÑ‚ÑÑ‚Ğ²Ğ¸Ğµ Ğ¸ Ğ¿Ñ€ĞµĞ´Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ Ğ½Ğ°Ñ‡Ğ°Ñ‚ÑŒ Ğ²Ğ²Ğ¾Ğ´ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…."""
    user = update.effective_user
    tg_id = user.id
    name = user.first_name

    # Ğ£Ğ±ĞµĞ¶Ğ´Ğ°ĞµĞ¼ÑÑ, Ñ‡Ñ‚Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒĞµÑ‚ Ğ² Ğ±Ğ°Ğ·Ğµ
    if not get_user(tg_id):
        create_user(tg_id, name)

    await update.message.reply_text(
        "ĞŸÑ€Ğ¸Ğ²ĞµÑ‚! Ğ¯ CosmoAstro â€” Ñ‚Ğ²Ğ¾Ğ¹ Ğ»Ğ¸Ñ‡Ğ½Ñ‹Ğ¹ Ğ°ÑÑ‚Ñ€Ğ¾Ğ»Ğ¾Ğ³ ğŸŒ™\n"
        "Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒÑ Ñ‚Ğ²Ğ¾Ñ Ğ½Ğ°Ñ‚Ğ°Ğ»ÑŒĞ½ÑƒÑ ĞºĞ°Ñ€Ñ‚Ñƒ, Ñ Ğ¿Ğ¾Ğ¼Ğ¾Ğ³Ñƒ Ñ‚ĞµĞ±Ğµ Ğ¿Ğ¾Ğ½ÑÑ‚ÑŒ, ĞºĞ°ĞºĞ¸Ğµ ÑĞ¸Ğ»ÑŒĞ½Ñ‹Ğµ ÑÑ‚Ğ¾Ñ€Ğ¾Ğ½Ñ‹ Ñ‚Ñ‹ Ğ½Ğµ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑˆÑŒ, \n"
        "Ğ² ĞºĞ°ĞºĞ¾Ğ¹ ÑÑ„ĞµÑ€Ğµ Ñ‚ĞµĞ±Ñ Ğ¶Ğ´Ñ‘Ñ‚ Ñ€Ğ¾ÑÑ‚, Ğ¸ Ğ³Ğ´Ğµ Ğ·Ğ°Ñ€Ñ‹Ñ‚ Ñ‚Ğ²Ğ¾Ğ¹ Ğ²Ğ½ÑƒÑ‚Ñ€ĞµĞ½Ğ½Ğ¸Ğ¹ Ñ€ĞµÑÑƒÑ€Ñ.\n\n"
        "ğŸª Ğ¢Ğ²Ğ¾Ñ Ğ½Ğ°Ñ‚Ğ°Ğ»ÑŒĞ½Ğ°Ñ ĞºĞ°Ñ€Ñ‚Ğ° â€” ÑÑ‚Ğ¾ ĞºĞ°Ğº Ğ½Ğ°Ğ²Ğ¸Ğ³Ğ°Ñ‚Ğ¾Ñ€, ĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğ¹ Ğ¿Ğ¾Ğ´ÑĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚:\n"
        "â€“ Ğ² Ñ‡Ñ‘Ğ¼ Ñ‚Ğ²Ğ¾Ñ ÑĞ¸Ğ»Ğ° Ğ¸ ĞºĞ°Ğº ĞµÑ‘ Ñ€Ğ°ÑĞºÑ€Ñ‹Ñ‚ÑŒ,\n"
        "â€“ ĞºĞ°ĞºĞ¸Ğµ ÑÑ„ĞµÑ€Ñ‹ Ğ¿Ñ€Ğ¸Ğ½ĞµÑÑƒÑ‚ Ñ‚ĞµĞ±Ğµ Ñ€Ğ¾ÑÑ‚, Ğ´ĞµĞ½ÑŒĞ³Ğ¸ Ğ¸ ÑƒĞ´Ğ¾Ğ²Ğ¾Ğ»ÑŒÑÑ‚Ğ²Ğ¸Ğµ,\n"
        "â€“ Ğ¸ Ğ½Ğµ Ğ¼ĞµĞ½ĞµĞµ Ğ²Ğ°Ğ¶Ğ½Ğ¾ â€” ĞºÑƒĞ´Ğ° ĞĞ• ÑÑ‚Ğ¾Ğ¸Ñ‚ Ğ»ĞµĞ·Ñ‚ÑŒ, Ğ´Ğ°Ğ¶Ğµ ĞµÑĞ»Ğ¸ ÑĞµĞ¹Ñ‡Ğ°Ñ ĞºĞ°Ğ¶ĞµÑ‚ÑÑ, Ñ‡Ñ‚Ğ¾ Â«Ğ½Ğ°Ğ´Ğ¾Â»."
    )

    await asyncio.sleep(3)
    await update.message.reply_text(
        "Ğ§Ñ‚Ğ¾Ğ±Ñ‹ Ğ²ÑÑ‘ ÑÑ‚Ğ¾ Ñ€Ğ°ÑÑÑ‡Ğ¸Ñ‚Ğ°Ñ‚ÑŒ â€” Ğ¼Ğ½Ğµ Ğ½ÑƒĞ¶Ğ½Ğ¾ Ğ·Ğ½Ğ°Ñ‚ÑŒ, ĞºĞ¾Ğ³Ğ´Ğ°, Ğ³Ğ´Ğµ Ğ¸ Ğ²Ğ¾ ÑĞºĞ¾Ğ»ÑŒĞºĞ¾ Ñ‚Ñ‹ Ñ€Ğ¾Ğ´Ğ¸Ğ»Ğ°ÑÑŒ âœ¨\nĞ“Ğ¾Ñ‚Ğ¾Ğ²Ğ°? ğŸ‘‡",
        reply_markup=InlineKeyboardMarkup(
            [[InlineKeyboardButton("ğŸ‘› Ğ“Ğ¾Ñ‚Ğ¾Ğ²Ğ°", callback_data="ready")]]
        ),
    )
    # Ğ Ğ°Ğ·Ğ³Ğ¾Ğ²Ğ¾Ñ€ Ğ½Ğµ Ğ½Ğ°Ñ‡Ğ¸Ğ½Ğ°ĞµÑ‚ÑÑ, Ğ¶Ğ´Ñ‘Ğ¼ Ğ½Ğ°Ğ¶Ğ°Ñ‚Ğ¸Ğµ ĞºĞ½Ğ¾Ğ¿ĞºĞ¸
    return ConversationHandler.END

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Ğ¨Ğ°Ğ³ 1 â€” Ğ´Ğ°Ñ‚Ğ° Ñ€Ğ¾Ğ¶Ğ´ĞµĞ½Ğ¸Ñ
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

async def ask_birth(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """ĞĞ±Ñ€Ğ°Ğ±Ğ°Ñ‚Ñ‹Ğ²Ğ°ĞµÑ‚ Ğ½Ğ°Ğ¶Ğ°Ñ‚Ğ¸Ğµ Â«Ğ“Ğ¾Ñ‚Ğ¾Ğ²Ğ°Â» Ğ¸ Ğ¿Ñ€Ğ¾ÑĞ¸Ñ‚ Ğ´Ğ°Ñ‚Ñƒ."""
    query = update.callback_query
    await query.answer()

    await query.message.reply_text(
        "1/3 â€” Ğ’Ğ²ĞµĞ´Ğ¸ Ğ´Ğ°Ñ‚Ñƒ Ñ€Ğ¾Ğ¶Ğ´ĞµĞ½Ğ¸Ñ (Ğ”Ğ”.ĞœĞœ.Ğ“Ğ“Ğ“Ğ“):",
        reply_markup=ReplyKeyboardRemove(),
    )
    return DATE

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Ğ¨Ğ°Ğ³ 2 â€” Ğ²Ñ€ĞµĞ¼Ñ Ñ€Ğ¾Ğ¶Ğ´ĞµĞ½Ğ¸Ñ
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

async def ask_time(update: Update, context: ContextTypes.DEFAULT_TYPE):
    try:
        birth_date = datetime.strptime(update.message.text.strip(), "%d.%m.%Y").date()
    except ValueError:
        await update.message.reply_text("ĞĞµĞ²ĞµÑ€Ğ½Ñ‹Ğ¹ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚. ĞŸÑ€Ğ¸Ğ¼ĞµÑ€: 02.03.1998")
        return DATE

    context.user_data["birth_date"] = birth_date
    await update.message.reply_text("2/3 â€” Ğ’Ğ²ĞµĞ´Ğ¸ Ğ²Ñ€ĞµĞ¼Ñ Ñ€Ğ¾Ğ¶Ğ´ĞµĞ½Ğ¸Ñ (Ğ§Ğ§:ĞœĞœ):")
    return TIME

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Ğ¨Ğ°Ğ³ 3 â€” Ğ³Ğ¾Ñ€Ğ¾Ğ´ Ğ¸ ÑÑ‚Ñ€Ğ°Ğ½Ğ°
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

async def ask_location(update: Update, context: ContextTypes.DEFAULT_TYPE):
    try:
        birth_time = datetime.strptime(update.message.text.strip(), "%H:%M").time()
    except ValueError:
        await update.message.reply_text("ĞĞµĞ²ĞµÑ€Ğ½Ñ‹Ğ¹ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚ Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ¸. ĞŸÑ€Ğ¸Ğ¼ĞµÑ€: 03:00")
        return TIME

    context.user_data["birth_time"] = birth_time
    await update.message.reply_text(
        "3/3 â€” Ğ’Ğ²ĞµĞ´Ğ¸ ÑÑ‚Ñ€Ğ°Ğ½Ñƒ Ğ¸ Ğ³Ğ¾Ñ€Ğ¾Ğ´ (Ğ½Ğ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€: Ğ›Ğ°Ñ‚Ğ²Ğ¸Ñ, Ğ Ğ¸Ğ³Ğ°):"
    )
    return LOCATION

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Ğ—Ğ°Ğ²ĞµÑ€ÑˆĞ°ĞµĞ¼: ÑĞ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»ÑŒ Ğ¸ Ğ¿Ñ€ĞµĞ´Ğ»Ğ°Ğ³Ğ°ĞµĞ¼ PDFâ€‘Ğ¿Ñ€Ğ¾Ğ´ÑƒĞºÑ‚
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

async def save_profile(update: Update, context: ContextTypes.DEFAULT_TYPE):
    parts = [p.strip() for p in update.message.text.split(",")]
    if len(parts) < 2:
        await update.message.reply_text("Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚: Ğ¡Ñ‚Ñ€Ğ°Ğ½Ğ°, Ğ“Ğ¾Ñ€Ğ¾Ğ´. ĞŸÑ€Ğ¸Ğ¼ĞµÑ€: Ğ›Ğ°Ñ‚Ğ²Ğ¸Ñ, Ğ Ğ¸Ğ³Ğ°")
        return LOCATION

    country, city = parts[0], parts[1]
    user = update.effective_user

    update_user(
        user.id,
        birth_date=str(context.user_data["birth_date"]),
        birth_time=context.user_data["birth_time"].strftime("%H:%M"),
        birth_country=country,
        birth_city=city,
    )

    await update.message.reply_text(
        "ĞÑ‚Ğ»Ğ¸Ñ‡Ğ½Ğ¾! Ğ¯ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ğ»Ğ° Ñ‚Ğ²Ğ¾Ğ¸ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¸ Ñ‡ĞµÑÑ‚Ğ½Ğ¾ ÑĞºĞ°Ğ¶Ñƒ: Ñ‚Ğ²Ğ¾Ñ ĞºĞ°Ñ€Ñ‚Ğ° Ğ¾Ñ‡ĞµĞ½ÑŒ Ğ½ĞµÑÑ‚Ğ°Ğ½Ğ´Ğ°Ñ€Ñ‚Ğ½Ğ°Ñ.\n"
        "ğŸª Ğ£Ğ¶Ğµ Ñ Ğ¿ĞµÑ€Ğ²Ğ¾Ğ³Ğ¾ Ğ²Ğ·Ğ³Ğ»ÑĞ´Ğ° Ğ²Ğ¸Ğ´Ğ½Ğ¾: Ñ‚Ñ‹ Ğ½Ğµ Ğ¸Ğ· Ñ‚ĞµÑ…, ĞºÑ‚Ğ¾ Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½ Â«Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾ Ğ¶Ğ¸Ñ‚ÑŒ, ĞºĞ°Ğº Ğ²ÑĞµÂ». Ğ£ Ñ‚ĞµĞ±Ñ ĞµÑÑ‚ÑŒ Ğ²Ğ½ÑƒÑ‚Ñ€ĞµĞ½Ğ½Ğ¸Ğ¹ Ğ²ĞµĞºÑ‚Ğ¾Ñ€.\n\n"
        "Ğ“Ğ¾Ñ‚Ğ¾Ğ²Ğ° ÑƒĞ·Ğ½Ğ°Ñ‚ÑŒ Ğ¾ ÑĞµĞ±Ğµ Ğ±Ğ¾Ğ»ÑŒÑˆĞµ?",
        reply_markup=InlineKeyboardMarkup(
            [[InlineKeyboardButton("ğŸ“œ ĞšĞ°Ñ€Ñ‚Ğ° Ğ¿Ñ€ĞµĞ´Ğ½Ğ°Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ñ", callback_data="product_destiny")]]
        ),
    )
    return ConversationHandler.END

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ĞÑ‚Ğ¼ĞµĞ½Ğ° Ğ²Ğ²Ğ¾Ğ´Ğ°
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

async def cancel(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text("ĞĞºĞµĞ¹, ĞµÑĞ»Ğ¸ Ñ‡Ñ‚Ğ¾ â€” /start", reply_markup=ReplyKeyboardRemove())
    return ConversationHandler.END

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ĞŸÑ€Ğ¾Ğ´Ğ°Ğ¶Ğ° PDFâ€‘ĞºĞ°Ñ€Ñ‚Ñ‹
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

async def destiny_product(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()

    await query.message.reply_text(
        "ĞšĞ°Ñ€Ñ‚Ğ° Ğ¿Ñ€ĞµĞ´Ğ½Ğ°Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ñ â€” Ğ¿ĞµÑ€ÑĞ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾Ğµ Ğ¿Ğ¾ÑĞ»Ğ°Ğ½Ğ¸Ğµ Ğ¾ Ñ‚Ğ²Ğ¾ĞµĞ¹ Ğ¼Ğ¸ÑÑĞ¸Ğ¸, Ñ‚Ğ°Ğ»Ğ°Ğ½Ñ‚Ğ°Ñ… Ğ¸ ÑÑ„ĞµÑ€Ğ°Ñ… Ñ€Ğ¾ÑÑ‚Ğ°.\n"
        "ĞŸĞ¾Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ¿Ñ€Ğ¸Ğ½Ğ¸Ğ¼Ğ°Ñ‚ÑŒ Ñ€ĞµÑˆĞµĞ½Ğ¸Ñ Ğ² Ğ³Ğ°Ñ€Ğ¼Ğ¾Ğ½Ğ¸Ğ¸ Ñ ÑĞ¾Ğ±Ğ¾Ğ¹.",
        reply_markup=InlineKeyboardMarkup(
            [[InlineKeyboardButton("ğŸ”® ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ ĞºĞ°Ñ€Ñ‚Ñƒ", callback_data="destiny_card")]]
        ),
    )

async def destiny_card_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """ĞÑ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ° PDF Ğ¿Ğ¾ÑĞ»Ğµ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸ Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ñ‹."""
    # ĞĞ¿Ñ€ĞµĞ´ĞµĞ»ÑĞµĞ¼, Ğ¾Ñ‚ĞºÑƒĞ´Ğ° Ğ¿Ñ€Ğ¸ÑˆÑ‘Ğ» Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ
    if update.callback_query is not None:
        query = update.callback_query
        await query.answer()
        tg_id = query.from_user.id
        message = query.message
    else:
        tg_id = update.effective_user.id
        message = update.message

    # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ Ğ² Ğ±Ğ°Ğ·Ğµ
    user_list = get_user(tg_id)
    if not user_list:
        await message.reply_text("ĞĞµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½ Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»ÑŒ. ĞŸÑ€Ğ¾Ğ¹Ğ´Ğ¸ /start.")
        return

    user = user_list[0]

    # Ğ•ÑĞ»Ğ¸ Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ğ° ÑƒĞ¶Ğµ Ğ¿Ñ€Ğ¾ÑˆĞ»Ğ° â€” Ğ³ĞµĞ½ĞµÑ€Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¸ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ PDF
    if user.get("paid_destiny"):
        await message.reply_text(
            "ĞĞ°Ñ‡Ğ¸Ğ½Ğ°Ñ Ñ€Ğ°ÑÑ‡Ñ‘Ñ‚ Ñ‚Ğ²Ğ¾ĞµĞ¹ Ğ½Ğ°Ñ‚Ğ°Ğ»ÑŒĞ½Ğ¾Ğ¹ ĞºĞ°Ñ€Ñ‚Ñ‹ ğŸŒŒ\n"
            "Ğ­Ñ‚Ğ¾ Ğ½Ğµ ÑˆĞ°Ğ±Ğ»Ğ¾Ğ½ â€” Ñ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒÑ Ñ‚Ğ²Ğ¾Ğ¸ Ñ€ĞµĞ°Ğ»ÑŒĞ½Ñ‹Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ.\n"
            "ğŸ•° Ğ­Ñ‚Ğ¾ Ğ·Ğ°Ğ¹Ğ¼Ñ‘Ñ‚ Ğ½ĞµÑĞºĞ¾Ğ»ÑŒĞºĞ¾ Ğ¼Ğ¸Ğ½ÑƒÑ‚. ĞšĞ°Ğº Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ ĞºĞ°Ñ€Ñ‚Ğ° Ğ±ÑƒĞ´ĞµÑ‚ Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ğ°, Ğ¿Ñ€Ğ¸ÑˆĞ»Ñ ĞµÑ‘ ÑÑĞ´Ğ°.\n\n"
            "ĞŸĞ¾ĞºĞ° Ğ¼Ğ¾Ğ¶ĞµÑˆÑŒ Ğ½Ğ°Ğ»Ğ¸Ñ‚ÑŒ ÑĞµĞ±Ğµ Ñ‡Ğ°Ğ¹ â˜•ï¸",
        )

        messages = build_destiny_prompt(
            name=user.get("name", "Ğ”Ñ€ÑƒĞ³"),
            date=datetime.strptime(user["birth_date"], "%Y-%m-%d").strftime("%d.%m.%Y"),
            time_str=user["birth_time"],
            city=user["birth_city"],
            country=user["birth_country"],
        )
        try:
            report_text = ask_gpt(
                messages,
                model="gpt-4-turbo",
                max_tokens=2500,
                temperature=0.9,
            )
        except Exception as e:
            print("GPT error:", e)
            await message.reply_text("ĞÑˆĞ¸Ğ±ĞºĞ° Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸. ĞŸĞ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞ¹ Ğ¿Ğ¾Ğ·Ğ¶Ğµ.")
            return

        # Ğ“ĞµĞ½ĞµÑ€Ğ¸Ñ€ÑƒĞµĞ¼ PDF Ğ¸ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
        try:
            pdf_bytes = text_to_pdf(report_text)
            public_url = upload_pdf_to_storage(user["id"], pdf_bytes)
            await message.reply_document(
                document=public_url,
                filename="Karta_Prednaznacheniya.pdf",
                caption=(
                    "Ğ“Ğ¾Ñ‚Ğ¾Ğ²Ğ¾! Ğ¯ ÑĞ¾Ğ±Ñ€Ğ°Ğ»Ğ° Ñ‚Ğ²Ğ¾Ñ Ğ½Ğ°Ñ‚Ğ°Ğ»ÑŒĞ½ÑƒÑ ĞºĞ°Ñ€Ñ‚Ñƒ ğŸ”®\n"
                    "Ğ’Ğ¾Ñ‚ Ñ‚Ğ²Ğ¾Ñ ĞšĞ°Ñ€Ñ‚Ğ° ĞŸÑ€ĞµĞ´Ğ½Ğ°Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ñ â€” Ñ Ğ¿Ğ¾Ğ´ÑĞºĞ°Ğ·ĞºĞ°Ğ¼Ğ¸ Ğ¾ ÑĞ¸Ğ»ÑŒĞ½Ñ‹Ñ… ÑÑ‚Ğ¾Ñ€Ğ¾Ğ½Ğ°Ñ…, \n"
                    "Ğ½Ğ° Ñ‡Ñ‘Ğ¼ ÑÑ‚Ñ€Ğ¾Ğ¸Ñ‚ÑŒ Ñ€ĞµĞ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ¸ Ñ‡ĞµĞ³Ğ¾ Ğ»ÑƒÑ‡ÑˆĞµ Ğ¸Ğ·Ğ±ĞµĞ³Ğ°Ñ‚ÑŒ.\n\n"
                    "Ğ’Ğ¿ĞµÑ€Ñ‘Ğ´ Ğº Ğ»ÑƒÑ‡ÑˆĞµĞ¹ Ğ²ĞµÑ€ÑĞ¸Ğ¸ ÑĞµĞ±Ñ!",
                ),
            )
        except Exception as e:
            print("PDF/upload error:", e)
            await message.reply_text(
                "ĞšĞ°Ñ€Ñ‚Ğ° Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ğ°, Ğ½Ğ¾ Ñ„Ğ°Ğ¹Ğ» Ğ½Ğµ Ğ¿Ñ€Ğ¸ĞºÑ€ĞµĞ¿Ğ¸Ğ»ÑÑ ğŸ˜”. Ğ’Ğ¾Ñ‚ Ñ‚ĞµĞºÑÑ‚:\n\n" + report_text
            )
        return

    # Ğ•ÑĞ»Ğ¸ Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ğ° Ğ½Ğµ Ğ¿Ñ€Ğ¾ÑˆĞ»Ğ° â€” ÑĞ¾Ğ·Ğ´Ğ°Ñ‘Ğ¼ ÑĞµÑÑĞ¸Ñ Stripe
    success_url = "https://t.me/CosmoAstrologyBot"
    cancel_url = "https://t.me/CosmoAstrologyBot"
    checkout_url = create_checkout_session(tg_id, "destiny", success_url, cancel_url)

    await message.reply_text(
        "Ğ§Ñ‚Ğ¾Ğ±Ñ‹ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ¿ĞµÑ€ÑĞ¾Ğ½Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ PDF-Ñ€Ğ°Ğ·Ğ±Ğ¾Ñ€, Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ğ¸ Ğ¿Ñ€Ğ¾Ğ´ÑƒĞºÑ‚ Ğ¿Ğ¾ ÑÑÑ‹Ğ»ĞºĞµ Ğ½Ğ¸Ğ¶Ğµ ğŸ‘‡",
        reply_markup=InlineKeyboardMarkup(
            [[InlineKeyboardButton("ğŸ’³ ĞĞ¿Ğ»Ğ°Ñ‚Ğ¸Ñ‚ÑŒ Ğ² Stripe", url=checkout_url)]]
        ),
    )
    await message.reply_text(
        "âš¡ï¸ ĞŸĞ¾ÑĞ»Ğµ Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ñ‹ Ğ²ĞµÑ€Ğ½Ğ¸ÑÑŒ Ğ² ÑÑ‚Ğ¾Ñ‚ Ñ‡Ğ°Ñ‚ Ğ¸ ÑĞ½Ğ¾Ğ²Ğ° Ğ½Ğ°Ğ¶Ğ¼Ğ¸ ĞºĞ½Ğ¾Ğ¿ĞºÑƒ Â«ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ ĞºĞ°Ñ€Ñ‚ÑƒÂ».\n"
        "ĞŸĞ»Ğ°Ñ‚Ñ‘Ğ¶ Ğ·Ğ°Ñ‰Ğ¸Ñ‰Ñ‘Ğ½. ĞĞ±Ñ‹Ñ‡Ğ½Ğ¾ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° Ğ·Ğ°Ğ½Ğ¸Ğ¼Ğ°ĞµÑ‚ 1â€“2 Ğ¼Ğ¸Ğ½ÑƒÑ‚Ñ‹. \n"
        "Ğ¡Ğ¿Ğ°ÑĞ¸Ğ±Ğ¾, Ñ‡Ñ‚Ğ¾ Ğ²Ñ‹Ğ±Ğ¸Ñ€Ğ°ĞµÑˆÑŒ CosmoAstro!",
    )



